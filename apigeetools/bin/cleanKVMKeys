#!/bin/bash

#
# cleanKVMKeys
# Flush (or "clear") a KVM
#
# usage:
#   cleanKVMKeys environment keyvaluemap_name

#set -e

USAGE="keyvaluemap_name"
TOOLSDIR="${APITOOLS_HOME}"
. "$TOOLSDIR/lib/functions"
parseCommandline "$@"
checkArgs 2 2

kvm_name="${ARGS[0]}"

debug "ARGS: org=$ORGANIZATION; env=$ENVIRONMENT; map=$kvm_name"

FRMT="json"

http_get "${APIGEE_HOST}/o/${ORGANIZATION}/e/${ENVIRONMENT}/keyvaluemaps/${kvm_name}?expand=true"

KVMap=`echo $RESPONSE | $HOME/apigee/lib/jp.sh -b | grep 'name"]' | cut -f 2 | sed -e 's/"//g'`

debug "KVMap= $KVMap"

for k in $KVMap ; do
	URL="$APIGEE_HOST/o/${ORGANIZATION}/e/${ENVIRONMENT}/keyvaluemaps/${kvm_name}/entries/$k"
	debug -e "delKeyEntry ==\t $delKeyEntry"
	http_delete $URL
	[[ $DEBUG -ge 2 ]] && read -p pause
done

