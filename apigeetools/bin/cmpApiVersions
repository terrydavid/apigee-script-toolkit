#!/bin/bash

# cmpApiVersions
#

# usage:
#   cmpApiVersions environment ApiProxyName
#set -e

USAGE="apiproxyname [revA [revB]] 
If only API name is provided compares LATEST_VERSION to DEPLOYED_VERSION  
If API name and <revA> are provided compares LATEST_VERSION to revA 
If API name, <revA> and <revB> are provided, compares revA to revB"

TOOLSDIR="${APITOOLS_HOME}"
. "$TOOLSDIR/lib/functions"
parseCommandline "$@"
checkArgs 2

API="${ARGS[0]}"
REVA="${ARGS[1]}"
REVB="${ARGS[2]}"

[[ ! ${API} ]] && usefail "No API found"

if [[ ! "${REVA}" ]] ; then
	REVA=`getApiRevisionLatest "$API"`
fi
debug "REVA=$REVA"

if [[ ! "${REVB}" ]] ; then
	REVB=`getApiRevisionDeployed "$API"`
fi
debug "REVB=$REVB"

[[ "$REVA" == "$REVB" ]] && usefail "Versions are the same"

printf "%-35s%6s%10s\n" "API" "RevOlder" "RevYounger"
printf "%-35s%6s%10s%s\n" "$API" "$REVA" "$REVB" "$TAG"

cd ${APISDIR}
debug "[cmpAPIVers]: cd ${APISDIR}"

dlApi "$API" "$REVA" "$API"-"$REVA".zip # 2>/dev/null
unzip -oq $API-$REVA.zip -d $API-$REVA # 2>&1 >/dev/null

dlApi "$API" "$REVB" "$API"-"$REVB".zip # 2>/dev/null
unzip -oq $API-$REVB.zip -d $API-$REVB # 2>&1 >/dev/null

diff -br "$API-$REVA" "$API-$REVB/" | grep -v '\(evision\|ersion\|anifest\|odified\)'
cd -