#!/bin/bash
 
#
# createApp
# creates a Developer App
#
# usage:
#   createApp host_alias app_name display_name api_product

#set -e

USAGE="host_alias app_name display_name api_product"
TOOLSDIR="${APITOOLS_HOME}"

. "$TOOLSDIR/config/global"
. "$TOOLSDIR/lib/functions"

parseCommandline "$@"
checkArgs 4
loadConfig "${ARGS[0]}"

APP_NAME=${ARGS[1]}
DISPLAY_NAME=${ARGS[2]}
API_PRODUCT=${ARGS[3]}

URL="${APIGEE_HOST}/o/${ORGANIZATION}/developers/${DEVELOPER}/apps"

BODY="{\"name\":\"${APP_NAME}\",\"accessType\":\"read\",\"callbackUrl\":\"http://nintendo.net\",\"apiProducts\":[\"${API_PRODUCT}\"],\"attributes\":[{\"name\":\"Developer\",\"value\":\"${DEVELOPER}\"},{\"name\":\"DisplayName\",\"value\":\"${DISPLAY_NAME}\"},{\"name\":\"Notes\",\"value\":\"\"}],\"developerEmail\":\"developer@nintendo.com\"}"

output=`curl -s -S --basic -u "$CREDENTIALS" -X POST -H "Accept: application/json" -H "Content-Type: application/json" --data-binary "$BODY" -w "\n%{http_code}" "${URL}"`

RESPONSE=`echo "$output" | sed '$ d'`

STATUS_CODE=`echo "$output" | tail -n 1`
if [ "$STATUS_CODE" != "201" ]; then
	fail "$(basename "$0") failed with status $STATUS_CODE: $RESPONSE"
fi
debug "response is $RESPONSE"
