#!/bin/bash

# listStaleApis
#
# lists the apis in an environment where the deployed version is less than the latest version
#
# usage:
#   listStaleApis environment

#set -e

USAGE="environment"
TOOLSDIR="${APITOOLS_HOME}"
. "$TOOLSDIR/lib/functions"
parseCommandline "$@"

APIS=`getApis ${OPTS[@]} "$HOST_ALIAS"`

for API in $APIS; do
	LATEST_REVISION=`getApiRevisionLatest ${OPTS[@]} -j "$HOST_ALIAS" "$API"`

	DEPLOYED_REVISION=`getApiRevisionDeployed ${OPTS[@]} -j "$ENVIRONMENT" "$API"`
	debug "Deployed: $DEPLOYED_REVISION ; Latest: $LATEST_REVISION"

	if [ ${DEPLOYED_REVISION:-0} -lt ${LATEST_REVISION:-0} ]; then
		echo "$API (latest: $LATEST_REVISION, deployed: $DEPLOYED_REVISION)"
	fi
done
