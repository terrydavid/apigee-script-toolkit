#!/bin/bash
#
# createKeyValueMap
# creates a Key/Value Map
#
# usage:
#   createKeyValueMap environment keyvaluemap_name
#
#Scoped to environment:
#$ curl -H "Content-Type:application/json" -X POST -d \
#{
#  "entry" : [ {
#    "name" : "dev",
#    "value" : "user1"
#  } ],
#  "name" : "prodmap"
#}
#-u myname:mypass https://api.enterprise.apigee.com/o/{org_name}/environments/{env_name}/keyvaluemaps
#

USAGE="keyvaluemap_name [kvm_keys_file]"
TOOLSDIR="${APITOOLS_HOME}"
. "${APITOOLS_HOME}/lib/functions"
parseCommandline "$@"
checkArgs 2

[[ $DEBUG -ge 3 ]] && set -x

kvm_name="${ARGS[0]}"
kvm_keys_file="${ARGS[1]}"

FRMT="json"

URL="${APIGEE_HOST}/o/${ORGANIZATION}/e/${ENVIRONMENT}/keyvaluemaps"

if [[ ! -f ${kvm_keys_file} ]] ; then 
	kvm_keys_file="${kvm_name}.json"
	echo -en "{ \"name\" : \"${kvm_name}\", \"entry\" : [ { \"name\" : \"${ARGS[0]}-APINAME\",  \"value\" : \"dummy1stEntry\" } ] }" > ${kvm_keys_file}
fi

LEN=`cat ${kvm_keys_file} | wc -c`
LEN=`echo "$LEN" | trims`

#HDRS="-HContent-Type:application/json -HContent-Length:${LEN}"
HDRS="-HContent-Length:${LEN}"
curlOPTS="--data-binary @${kvm_keys_file}"

#KFNAME=`cat ${kvm_keys_file}`
#debug " checking kvm file ${kvm_keys_file}: $KFNAME"

http_post "$URL"

debug "Status Code [$STATUS_CODE] response is: \n$RESPONSE"
echo $STATUS_CODE

set -